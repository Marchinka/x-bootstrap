<script src="./../../node_modules/x-tag/dist/x-tag-core.js"></script>
<link rel="import" href="./../behaviours/element-base-behaviour.html">

<template id="collection-container-template">
    <style type="text/css">
        a {
            cursor: pointer;
        }
    </style>
    <div id="inner-content"></div>
    <div hidden class="show-more">
        <button id="show-more-button" class="btn btn-default">Show More</button>
    </div>
    <ul hidden class="pager">
        <li><a id="previous-button">Previous</a></li>
        <li><a id="next-button">Next</a></li>
    </ul>
</template>

<script>
(function(window, document) {
    var thatDoc = document;
    var thisDoc = document._currentScript.ownerDocument;
    var template = thisDoc.querySelector('#collection-container-template').content;
    var element = {
        accessors: {
            url: {
                attribute: { },
                get: function() {
                    return this.getAttribute('url');
                },
                set: function(data) {
                    this.xtag.data.url = data;
                }
            },
            infiniteScrolling: {
                attribute: { boolean: true },
                get: function() {
                    return this.hasAttribute('infinite-scrolling');
                },
                set: function(data) {
                    this.xtag.data.infiniteScrolling = data;
                }
            },
            showMoreButton: {
                attribute: { boolean: true },
                get: function() {
                    return this.hasAttribute('show-more-button');
                },
                set: function(data) {
                    this.xtag.data.showMoreButton = data;
                }
            },  
            pager: {
                attribute: { boolean: true },
                get: function() {
                    return this.hasAttribute('pager');
                },
                set: function(data) {
                    this.xtag.data.pager = data;
                }
            },  
            elementsPerPage: {
                attribute: { },
                get: function() {
                    return this.getAttribute('elements-per-page');
                },
                set: function(data) {
                    this.xtag.data.elementsPerPage = data;
                }
            },              
            currentPage: {
                attribute: { },
                get: function() {
                    return this.getAttribute('current-page');
                },
                set: function(data) {
                    this.xtag.data.currentPage = data;
                }
            },            
        },
        lifecycle: {
            created: function () {
                this.innerContent = this.innerHTML;
                this.innerHTML = '';
                var clone = thatDoc.importNode(template, true);
                this.getRenderingRoot().appendChild(clone);
                this.selectInRenderingRoot("#inner-content").innerHTML = this.innerContent;
                this.collectionElementTag = this.selectInRenderingRoot("collection-elements");
                this.searchForm = this.selectInRenderingRoot("collection-search-form");
                this.showMoreButtonTag = this.selectInRenderingRoot("#show-more-button");
                this.nextButton = this.selectInRenderingRoot("#next-button");
                this.previousButton = this.selectInRenderingRoot("#previous-button");
                this.currentPage = this.currentPage || 1;
            },
            inserted: function () {
                var self = this;
                if (self.infiniteScrolling) {
                    window.addEventListener("scroll", function () {                    
                        var positionOffset = window.innerHeight + window.scrollY - thatDoc.body.offsetHeight;
                        if (positionOffset >= 0) {
                            self._appendNextPageData();
                        }                    
                    }, false);
                }
                else if (self.showMoreButton) {
                    self.selectInRenderingRoot(".show-more").hidden = false;
                    self.showMoreButtonTag.onclick = function() {
                        self._appendNextPageData();
                    };
                }
                else if (self.pager) {
                    self.selectInRenderingRoot(".pager").hidden = false;
                    self.nextButton.onclick = function() {
                        self._fetchNextPageData();
                    };
                    self.previousButton.onclick = function() {
                        self._fetchPreviousPageData();
                    };                    
                }             
                self.fetchData();
            }
        },
        methods: {
            fetchData: function() {
                var self = this;

                if (!self.url) {
                    throw new Error("Url is not defined");
                }

                if (!self.collectionElementTag) {
                     throw new Error("No <collection-elements/> found as inner contet of <collection-container/>.");
                }   

                if (!window.restService) {
                    throw new Error("'restService' must be assigned to main window for <collection-container/> to work correctly");   
                }      
               
                var formData = {};
                if (self.searchForm) {
                    var isFormValid = self.searchForm.validate();
                    if (!isFormValid) {
                        return;
                    }
                    formData = self.searchForm.getData();    
                }
                formData.page = this.currentPage;
                formData.elementsPerPage = this.elementsPerPage;

                window.restService.ajax({
                    url: self.url,
                    method: "GET",
                    data: formData,
                    success: function (result) {
                        self.collectionElementTag.addResults(result);
                    }
                });                
            },
            _appendNextPageData: function () {
                this.currentPage++;
                this.fetchData();
                //var br = document.createElement("br");
                //this.getRenderingRoot().querySelector("collection-elements").getRenderingRoot().appendChild(br);
                //var p = document.createElement("p");
                //p.textContent = "guarda che figo";
                //this.getRenderingRoot().querySelector("collection-elements").getRenderingRoot().appendChild(p);
            },
            _fetchNextPageData: function () {
                this.collectionElementTag.emptyCollection();
                this.currentPage++;
                this.fetchData();
            },
            _fetchPreviousPageData: function () {
                if (this.currentPage == 1) {
                    return;
                }
                this.collectionElementTag.emptyCollection();
                this.currentPage--;
                this.fetchData();
            }
        },
        events: {
            submit: function (e) {
                e.preventDefault();
                this.currentPage = 1;
                this.fetchData();
            },
            tap: function () {

            }
        }
    };
    xtag.register('collection-container', xtag.merge(xBootstrap.getElementBase(), element));
})(window, document);
</script>
