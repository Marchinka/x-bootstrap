<script src="./../../node_modules/x-tag/dist/x-tag-core.js"></script>
<script src="./../behaviours/input-behaviours.js"></script>

<template id="form-ajax-template">
    <form>
    </form>
</template>

<script>
(function(window, document) {
    var thatDoc = document;
    var thisDoc = document._currentScript.ownerDocument;
    var template = thisDoc.querySelector('#form-ajax-template').content;
    var element = {
        accessors: {
            postUrl: {
                attribute: {},
                get: function() {
                    return this.getAttribute('post-url') || '';
                },
                set: function(data) {
                    this.xtag.data.postUrl = data;
                }
            },
            getUrl: {
                attribute: {},
                get: function() {
                    return this.getAttribute('get-url') || '';
                },
                set: function(data) {
                    this.xtag.data.getUrl = data;
                }
            },            
            redirectUrl: {
                attribute: {},
                get: function() {
                    return this.getAttribute('redirect-url') || '';
                },
                set: function(data) {
                    this.xtag.data.redirectUrl = data;
                }
            },
            redirectHash: {
                attribute: {},
                get: function() {
                    return this.getAttribute('redirect-hash') || '';
                },
                set: function(data) {
                    this.xtag.data.redirectHash = data;
                }
            },
            redirectToId: {
                attribute: { boolean: true },
                get: function() {
                    return this.hasAttribute('redirect-to-id') || '';
                },
                set: function(data) {
                    this.xtag.data.redirectToId = data;
                }
            },
            redirectUrl: {
                attribute: {},
                get: function() {
                    return this.getAttribute('redirect-url') || '';
                },
                set: function(data) {
                    this.xtag.data.redirectUrl = data;
                }
            },
            clearOnSuccess: {
                attribute: { boolean: true },
                get: function() {
                    return this.hasAttribute('clear-on-success') || '';
                },
                set: function(data) {
                    this.xtag.data.clearOnSuccess = data;
                }
            },
        },
        lifecycle: {
            created: function() {
                this.innerContent = this.innerHTML;
                this.innerHTML = '';
                var clone = thatDoc.importNode(template, true);
                this._getRenderingRoot().appendChild(clone);
                this.form = this._selectInRenderingRoot('form');
                this.render();
            },
            inserted: function () {
                var self = this;
                if (self.getUrl) {
                    window.restService.ajax({
                        url: self.getUrl,
                        method: "GET",
                        data: {},
                        success: function (result) {
                             self.setData(result);
                        }
                    });                     
                }
            }

        },
        methods: {
            render: function ()
            {
                this.form.innerHTML = this.innerContent;
            },
            _submitForm: function () {
                var self = this;

                if (!self.postUrl) {
                    throw new Error("Post url is not defined");
                }

                var formData = self.getData();
                window.restService.ajax({
                    url: self.postUrl,
                    method: "POST",
                    data: formData,
                    success: function (result) {
                         self.clearingProcedure(self);
                         self.redirectProcedure(self);
                    }
                });                
            },
            clearingProcedure: function (self) {
                if (self.clearOnSuccess) {
                    self.clearForm();
                    return;
                }
            },
            redirectProcedure: function(self) {
                if (self.redirectUrl) {
                    var redirectUrl = self.redirectUrl;
                    if (self.redirectToId) {
                        redirectUrl += "/" + result.resultId;
                    }

                    if (self.redirectHash) {
                        var newUrl = window.location.origin + "/" + redirectUrl + "/#" + self.redirectHash;
                        window.location.href = newUrl;
                    } else {
                        window.location.pathname = redirectUrl;    
                    }
                    return;
                }

                if (self.redirectHash) {
                    var redirectHash = self.redirectHash;
                    if (self.redirectToId) {
                        redirectHash += "/" + result.resultId;
                    }
                    window.location.hash = redirectHash;
                    return;
                }                 
            }
        },
        events: {
            submit: function (e) {
                e.preventDefault();
                var isFormValid = this.validate();
                if (isFormValid) {
                    this._submitForm();
                }
            }
        }
    };
    xtag.register('form-ajax', xtag.merge(FormBehaviours.formElementBase, element));
})(window, document);
</script>
